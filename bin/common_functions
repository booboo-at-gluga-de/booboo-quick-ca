#!/usr/bin/env bash

# BooBoo Quick CA
# Copyright (C) 2017, Bernd Stroessenreuther <booboo@gluga.de>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 3.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.


# 2017-06-01 booboo:
# defining colors, functions, ... used by more than one of the
# other scripts in this directory

# .-- color definitions --------------------------------------------------.
HEADLINE_COLOR='\033[1;34m'
RED='\033[1;31m'
GREEN='\033[1;32m'
ORANGE='\033[0;33m'
NO_COLOR='\033[0m'

#.
function display_rc { # .-------------------------------------------------.
    RC=$1
    EXIT_AFTER_DISPLAY=$2

    if [[ $RC -eq 0 ]]; then
        echo -e :: Result: ${GREEN}Good${NO_COLOR}
    else
        echo -e :: Result: ${RED}Problem!${NO_COLOR}

        if [[ $EXIT_AFTER_DISPLAY -ne 0 ]]; then
            exit 1
        fi
    fi
}

#.
function create_crl_root_ca { # .-----------------------------------------.
    if [[ ! -z "$ROOT_CA_CRL_DISTRIBUTION_POINTS" ]]; then
        echo ::
        echo -e :: ${HEADLINE_COLOR}Creating a Certificate Revocation List \(CRL\) for the Root CA...${NO_COLOR}
        echo ::

        RC=255
        while [[ $RC -ne 0 ]]; do
            openssl ca -config $ROOT_CA_OPENSSL_CNF_FILE -gencrl -out $ROOT_CA_CRL_FILE
            RC=$?
            [[ $RC -ne 0 ]] && echo -e :: ${ORANGE}WARNING: This did not work. Retrying...${NO_COLOR}
        done

        echo :: You now have:
        openssl crl  -text -noout -in $ROOT_CA_CRL_FILE
        chmod 644 $ROOT_CA_CRL_FILE
    else
        echo ::
        echo -e :: ${HEADLINE_COLOR}No Certificate Revocation List \(CRL\) will be created for the Root CA${NO_COLOR}
        echo :: because ROOT_CA_CRL_DISTRIBUTION_POINTS is not set in
        echo :: $QUICK_CA_CFG_FILE
        echo ::
    fi
}

#.
function create_crl_issuing_ca { # .-----------------------------------------.
    if [[ ! -z "$ISSUING_CA_CRL_DISTRIBUTION_POINTS" ]]; then
        echo ::
        echo -e :: ${HEADLINE_COLOR}Creating a Certificate Revocation List \(CRL\) for the Issuing CA...${NO_COLOR}
        echo ::

        RC=255
        while [[ $RC -ne 0 ]]; do
            openssl ca -config $ISSUING_CA_OPENSSL_CNF_FILE -gencrl -out $ISSUING_CA_CRL_FILE
            RC=$?
            [[ $RC -ne 0 ]] && echo -e :: ${ORANGE}WARNING: This did not work. Retrying...${NO_COLOR}
        done

        echo :: You now have:
        openssl crl  -text -noout -in $ISSUING_CA_CRL_FILE
        chmod 644 $ISSUING_CA_CRL_FILE
    else
        echo ::
        echo -e :: ${HEADLINE_COLOR}No Certificate Revocation List \(CRL\) will be created for the Issuing CA${NO_COLOR}
        echo :: because ISSUING_CA_CRL_DISTRIBUTION_POINTS is not set in
        echo :: $QUICK_CA_CFG_FILE
        echo ::
    fi
}

#.
